# 简介
Mindcluster_diag_tool通过在线采集或离线日志分析设备链路故障，包含服务器、交换设备（L1/L2 灵衢交换机、 RoCE交换机）、BMC管理。

* **在线采集**

用户输入待访问设备的连接信息（账号、密码/密钥/免密），工具访问设备采集信息

* **离线分析**

用户导入采集服务器带内日志、BMC dump日志、交换设备diagnostic information日志，分析出关键信息

* **故障分析**

结合在线/离线采集信息，继承故障模式，进行故障分析

# 接口描述

## 具体命令接口
### 基础命令

#### help
显示帮助信息

| 命令格式 | 描述 |
|---------|------|
| help | 显示所有可用命令的帮助信息 |


#### exit
退出程序

| 命令格式 | 描述 |
|---------|------|
| exit | 退出诊断工具 |


#### clear
清屏

| 命令格式 | 描述 |
|---------|------|
| clear | 清空终端屏幕 |


#### about
查看关于诊断工具

| 命令格式 | 描述 |
|---------|------|
| about | 显示诊断工具的版本和联系信息 |


#### guide
获取向导信息

| 命令格式 | 描述 |
|---------|------|
| guide | 显示诊断工具的使用向导 |


### 配置命令

#### set_conn_config
设置连接配置

| 命令格式 | 描述 |
|---------|------|
| set_conn_config <文件地址> | 设置设备连接配置文件 |
| set_conn_config ? | 查看详细配置说明 |


**参数说明**：
- `<文件地址>`：连接配置文件的路径

**配置文件结构**：
```ini
[host]
# port指定端口,不写默认为22, username指定用户名, password指定密码, private_key指定私钥文件
1.1.1.1 port="22" username="root" private_key="~/.shh/your_private_key"
1.1.2.1 port="22" username="root" password="321" 

[bmc]
1.1.1.2 username="Administrator" password="123"

[switch]
# 支持ip1-ip2 ip段方式填写(需保证账号密码相同), 通过step设置步长
1.1.1.3-1.1.1.10 step=1 username="root" password="123"

[config]
# 支持设置全局的私钥文件
private_key="~/.shh/your_private_key"
```

#### set_host_dump_log
设置服务器导出日志目录

| 命令格式 | 描述 |
|---------|------|
| set_host_dump_log <目录> | 设置服务器导出日志目录 |
| set_host_dump_log ? | 查看详细说明 |


**参数说明**：
- `<目录>`：服务器日志目录路径

**支持的日志类型**：
- A3device日志一键采集脚本<version>.sh
- link_down_collect_<version>.sh
- tool_log_collection_out_version_all_<version>.sh

#### set_bmc_dump_log
设置BMC日志目录

| 命令格式 | 描述 |
|---------|------|
| set_bmc_dump_log <目录> | 设置BMC日志目录 |
| set_bmc_dump_log ? | 查看详细说明 |


**参数说明**：
- `<目录>`：BMC日志目录路径

**支持的日志类型**：
- 手动通过BMC网页 "一键收集" 按钮下载的日志
- 通过命令 `ipmcget -d diaginfo` 采集的日志

#### set_switch_dump_log
设置交换机命令回显文本目录

| 命令格式 | 描述 |
|---------|------|
| set_switch_dump_log <目录> | 设置交换机命令回显目录 |
| set_switch_dump_log ? | 查看详细说明 |


**参数说明**：
- `<目录>`：交换机日志目录路径

**支持的日志类型**：
- 使用交换机 `display diagnostic-information <filename>` 命令导出的结果
- 查询关键命令后复制的shell回显文本
- 使用交换机 `collect diagnostic-information` 命令导出的日志zip包

### 采集命令

#### collect_bmc_dump_info
在线收集BMC dump info日志

| 命令格式 | 描述 |
|---------|------|
| collect_bmc_dump_info | 在线收集BMC dump info日志 |


**输出说明**：
- 收集完成后，日志位于 `CommonPath.TOOL_HOME_BMC_DUMP_CACHE_DIR` 目录

#### auto_collect
启动自动信息采集

| 命令格式 | 描述 |
|---------|------|
| auto_collect | 启动自动信息采集 |
| auto_collect ? | 查看详细说明 |


**功能说明**：
- 支持离线、在线采集
- 适用于不同网络平面分批收集

### 诊断命令

#### auto_inspection
启动巡检结果诊断

| 命令格式 | 描述 |
|---------|------|
| auto_inspection | 使用默认客户类型启动诊断 |
| auto_inspection <客户类型> | 使用指定客户类型启动诊断 |
| auto_inspection ? | 查看支持的客户类型 |


**参数说明**：
- `<客户类型>`：支持的客户类型枚举值

**支持的客户类型**：
- Mayi

#### auto_diag
启动自动诊断

| 命令格式 | 描述 |
|---------|------|
| auto_diag | 启动自动诊断 |
| auto_diag ? | 查看详细说明 |


**功能说明**：
- 适用于分批收集后统一诊断

#### auto_collect_diag
启动一键式自动收集诊断

| 命令格式 | 描述 |
|---------|------|
| auto_collect_diag | 启动一键式自动收集和诊断 |


**功能说明**：
- 自动执行收集（在线设备采集或离线日志收集）和诊断流程

### 维护命令

#### clear_cache
清理缓存

| 命令格式 | 描述 |
|---------|------|
| clear_cache | 清理诊断工具缓存 |


**功能说明**：
- 清理工具运行过程中产生的缓存文件
- 建议在执行新诊断任务前执行
- 若清理未生效，请使用管理员模式打开工具

## 接口调用流程

### 在线诊断流程

1. 使用 `set_conn_config` 设置设备连接配置
2. 使用 `auto_collect_diag` 启动一键式诊断
3. 诊断完成后使用 `clear_cache` 清理缓存

### 离线诊断流程

1. 使用 `set_host_dump_log` 设置服务器日志目录
2. 使用 `set_bmc_dump_log` 设置BMC日志目录
3. 使用 `set_switch_dump_log` 设置交换机日志目录
4. 使用 `auto_collect_diag` 启动一键式诊断
5. 诊断完成后使用 `clear_cache` 清理缓存

### 分批诊断流程

1. 使用配置命令设置部分设备信息
2. 使用 `auto_collect` 收集设备信息
3. 重复步骤1-2设置和收集其他设备信息
4. 使用 `auto_diag` 启动统一诊断
5. 诊断完成后使用 `clear_cache` 清理缓存


## 默认配置

当未手动设置以下路径时，工具会自动读取执行路径下的默认文件或目录：

- 连接配置：conn.ini
- BMC日志目录：bmc_dump_log
- Host日志目录：host_dump_log
- 交换机日志目录：switch_dump_log

## 版本信息

工具版本信息可通过 `about` 命令查看。

# 详细功能

## 数据源详细描述

### 概述

本文档详细描述了诊断工具支持的各类数据源，包括：
- 数据类型及具体数据项
- 数据采集方式（SSH在线采集/离线日志解析）
- 数据来源位置（具体命令/文件路径）

工具支持三种设备类型的数据源采集：
1. 主机（Host）
2. BMC（Baseboard Management Controller）
3. 交换机（Switch）

每种设备支持两种采集方式：
- **SSH在线采集**：通过SSH连接到设备，执行命令获取实时数据
- **离线日志解析**：解析已导出的日志文件，提取历史数据

---

### 主机（Host）数据源

#### SSH在线采集

| 数据项 | 采集命令                                                 | 说明 |
|--------|------------------------------------------------------|------|
| 主机名 | `hostname`                                           | 获取主机名称 |
| NPU映射信息 | `npu-smi info -m`                                    | 获取NPU芯片映射关系（NPU ID、芯片ID、物理ID） |
| 光模块信息 | `hccn_tool -i {chip_phy_id} -optical -g`             | 获取指定物理芯片的光模块信息 |
| 链路状态 | `hccn_tool -i {chip_phy_id} -link_stat -g`           | 获取指定物理芯片的链路状态 |
| 统计信息 | `hccn_tool -i {chip_phy_id} -stat -g`                | 获取指定物理芯片的统计信息 |
| LLDP信息 | `hccn_tool -i {chip_phy_id} -lldp -g`                | 获取指定物理芯片的LLDP邻居信息 |
| NPU类型 | `lspci \| grep 'Device d80'`                         | 获取NPU设备类型 |
| 系统序列号 | `dmidecode -s system-serial-number`                  | 获取系统序列号 |
| HCCS信息 | `npu-smi info -t hccs -i {npu_id} -c {chip_id}`      | 获取指定NPU和芯片的HCCS信息 |
| SPOD信息 | `npu-smi info -t spod-info -i {npu_id} -c {chip_id}` | 获取指定NPU和芯片的SPOD信息 |
| MSNPUREPORT日志 | `msnpureport`                                        | 生成并解析MSNPUREPORT日志 |
| RoCE速度 | `hccn_tool -i {chip_phy_id} -speed -g`               | 获取指定物理芯片的RoCE速度 |
| RoCE双工模式 | `hccn_tool -i {chip_phy_id} -duplex -g`              | 获取指定物理芯片的RoCE双工模式 |
| 网络健康状态 | `hccn_tool -i {chip_phy_id} -net_health -g`          | 获取指定物理芯片的网络健康状态 |
| 链路状态 | `hccn_tool -i {chip_phy_id} -link_status -g`         | 获取指定物理芯片的链路状态 |
| CDR信息 | `hccn_tool -i {chip_phy_id} -scdr -t 5`              | 获取指定物理芯片的CDR信息 |
| DFX配置 | `hccn_tool -i {chip_phy_id} -optical -g dfx_cfg`     | 获取指定物理芯片的DFX配置 |
| 光模块环回测试 | `hccn_tool -i {npu_id} -optical -t {model}`          | 执行光模块环回测试 |

#### 离线日志解析

主机离线日志支持三种不同版本的配置集合，每种集合对应不同的文件路径和解析关键词。

##### 版本1配置（ParseConfigCollectionV1）

**文件结构**：
```
日志目录/
├── hccn_tool.log        # 网络配置工具日志
├── npu_card_info.log    # NPU卡信息日志
├── pcie_info.log        # PCIe信息日志
└── version_info.log     # 版本信息日志
```

**数据项与解析配置**：

| 数据类型 | 解析关键词 | 日志文件路径 | 说明 |
|----------|------------|--------------|------|
| LLDP | "lldp" | hccn_tool.log | 链路层发现协议信息 |
| SPEED | "speed -g" | hccn_tool.log | 端口速度信息 |
| OPTICAL | "optical" | hccn_tool.log | 光模块信息 |
| LINK_STAT | "link stat" | hccn_tool.log | 链路统计信息 |
| STAT | "stat" | hccn_tool.log | 性能统计信息 |
| HCCN_LINK_STATUS | "link" | hccn_tool.log | HCCN链路状态 |
| CDR_SNR | "cdr5 snr 1 times" | hccn_tool.log | CDR信噪比信息 |
| SPOD_INFO | "Collect spod-info info for all NPUs" | npu_card_info.log | SPOD信息 |
| HCCS | "Collect hccs info for all NPUs" | npu_card_info.log | HCCS协议信息 |
| NPU_TYPE | "lspci" | pcie_info.log | NPU类型信息 |
| SN | "timeout 30s dmidecode -t1" | version_info.log | 序列号信息 |

##### 版本2配置（ParseConfigCollectionV2）

**文件结构**：
```
日志目录/
├── hccn_log/
│   ├── net_conf.log     # 网络配置日志
│   ├── optical.log      # 光模块日志
│   └── stat.log         # 统计信息日志
├── npu_smi_log/
│   └── npu_smi.log      # NPU SMI日志
└── pcie_log/
    └── pcie.log         # PCIe日志
```

**数据项与解析配置**

| 数据类型 | 解析关键词 | 日志文件路径 | 说明 |
|----------|------------|--------------|------|
| LLDP | "lldp" | hccn_log/net_conf.log | 链路层发现协议信息 |
| SPEED | "speed" | hccn_log/net_conf.log | 端口速度信息 |
| OPTICAL | "optical" | hccn_log/optical.log | 光模块信息 |
| LINK_STAT | "link stat" | hccn_log/optical.log | 链路统计信息 |
| NET_HEALTH | "health info" | hccn_log/optical.log | 网络健康信息 |
| HCCN_LINK_STATUS | "link info" | hccn_log/optical.log | HCCN链路状态 |
| STAT | "stat" | hccn_log/stat.log | 性能统计信息 |
| SPOD_INFO | "spod_info" | npu_smi_log/npu_smi.log | SPOD信息 |
| HCCS | "hccs" | npu_smi_log/npu_smi.log | HCCS协议信息 |
| NPU_TYPE | "pcie" | pcie_log/pcie.log | NPU类型信息 |

##### 版本3配置（ParseConfigCollectionV3）

**文件结构**：
```
日志目录/
├── lldp.log        # LLDP日志
└── optical.log     # 光模块日志
```

**数据项与解析配置**

| 数据类型 | 解析关键词 | 日志文件路径 | 说明 |
|----------|------------|--------------|------|
| LLDP | "lldp" | lldp.log | 链路层发现协议信息 |
| SPEED | "speed info" | optical.log | 端口速度信息 |
| OPTICAL | "optical" | optical.log | 光模块信息 |
| LINK_STAT | "link stat" | optical.log | 链路统计信息 |
| HCCN_LINK_STATUS | "link info" | optical.log | HCCN链路状态 |

#### MSNPUREPORT日志

除上述配置外，还支持解析MSNPUREPORT工具生成的日志，该日志位于：
- 路径：日志目录下的时间戳子目录（如`2023-10-01_14-30-00`）
- 内容：包含详细的NPU报告信息

---

### BMC数据源

#### SSH在线采集

| 数据项 | 采集命令 | 说明 |
|--------|----------|------|
| BMC序列号 | `ipmcget -d serialnumber` | 获取BMC序列号 |
| BMC日期时间 | `ipmcget -d time` | 获取BMC当前时间 |
| SEL日志 | `ipmcget -d sel -v list` | 获取系统事件日志 |
| 传感器信息 | `ipmcget -t sensor -d list` | 获取传感器列表及状态 |
| 健康事件 | `ipmcget -d healthevents` | 获取健康事件日志 |
| 诊断信息 | `ipmcget -d diaginfo` | 获取BMC诊断信息并下载为压缩包 |
| 光模块历史日志 | - | 获取光模块历史记录（当前未实现） |


**诊断信息压缩包**：
- 远程路径：`/tmp/dump_info.tar.gz`
- 本地存储路径：`CommonPath.TOOL_HOME_BMC_DUMP_CACHE_DIR`
- 命名格式：`{host}_{sn_num}_{subfix_date_time}.tar.gz`

#### 离线日志解析

**日志来源**：BMC离线日志通常通过`ipmcget -d diaginfo`命令生成的诊断信息压缩包（`dump_info.tar.gz`）获取，解压后包含以下目录结构：

```
dump_info/
└── AppDump/
    ├── bmc_network/
    │   └── network_info.txt      # 网络信息文件
    ├── frudata/
    │   └── fruinfo.txt           # FRU信息文件
    ├── event/
    │   ├── sel.txt               # 系统事件日志
    │   └── current_event.txt     # 当前健康事件
    ├── sensor/
    │   └── sensor_info.txt       # 传感器信息
    ├── network_adapter/
    │   └── optical_module/
    │       └── optical_module_history_info_log.csv  # 光模块历史日志1
    └── CpuMem/
        └── NpuIO/
            └── optical_module_history_info_log.csv  # 光模块历史日志2
```

**数据项与来源**：

| 数据项 | 日志文件路径 | 解析方式 |
|--------|--------------|----------|
| BMC IP地址 | `AppDump/bmc_network/network_info.txt` | 从文件中提取"IP Address"字段 |
| 序列号 | `AppDump/frudata/fruinfo.txt` | 从FRU信息中提取"System Serial Number" |
| SEL信息 | `AppDump/event/sel.txt` | 直接读取SEL日志内容 |
| 传感器信息 | `AppDump/sensor/sensor_info.txt` | 直接读取传感器信息内容 |
| 健康事件 | `AppDump/event/current_event.txt` | 直接读取健康事件内容 |
| 光模块历史日志 | <ul><li>`AppDump/network_adapter/optical_module/optical_module_history_info_log.csv`</li><li>`AppDump/CpuMem/NpuIO/optical_module_history_info_log.csv`</li></ul> | 解析CSV格式的光模块历史记录，提取链路中断记录 |

---

### 交换机（Switch）数据源

#### SSH在线采集

| 数据项 | 采集命令 | 说明 |
|--------|----------|------|
| 交换机序列号 | `display license esn` | 获取交换机ESN序列号 |
| 接口摘要 | `dis int b \| no-more` | 获取所有接口的基本状态 |
| 交换机名称 | `dis cu \| in sysname` | 获取交换机系统名称 |
| 光模块信息 | `dis optical-module interface {interface}` | 获取指定接口的光模块信息 |
| 误码率 | `display interface troubleshooting {interface}` | 获取指定接口的故障排除信息 |
| LLDP邻居 | `dis lldp nei b \| n` | 获取LLDP邻居摘要 |
| 活动告警 | `display alarm active \| no-more` | 获取当前活动告警 |
| 历史告警 | `display alarm history \| no-more` | 获取历史告警记录 |
| 接口信息 | `display interface \| no-more` | 获取所有接口的详细信息 |
| 当前时间 | `display clock \| include -` | 获取交换机当前时间 |
| HCCS代理响应统计 | `display hccs proxy response statistics \| no-more` | 获取HCCS代理响应统计 |
| HCCS代理响应详情 | `display hccs proxy response detail interface {interface}` | 获取指定接口的HCCS代理响应详情 |
| HCCS路由缺失 | `display hccs route miss statistics \| no-more` | 获取HCCS路由缺失统计 |
| 端口链路状态 | `display for info enp s 1 c {chip_id} "get port link start 0 end 47" \| no-more` | 获取芯片端口链路状态 |
| 端口统计 | `display for info enp s 1 c {chip_id} "get port statistic count port {port_id} module {module} type 0 path 2" \| no-more` | 获取端口统计信息 |
| HCCS端口无效丢弃 | `display hccs port-invalid drop statistics \| no-more` | 获取HCCS端口无效丢弃统计 |
| 端口信用背压统计 | `display qos port-credit back-pressure statistics \| no-more` | 获取端口信用背压统计 |
| HCCS端口SNR | `display interface hilink snr \| n` | 获取HCCS端口信噪比 |
| 收发器信息 | `display interface transceiver verbose \| no-more` | 获取接口收发器详细信息 |
| 接口通道信息 | `display interface information \| no-more` | 获取接口通道信息 |
| Serdes转储信息 | `display for info enp s 1 c {chip_id} "get port serdes dump-info marco-id {port_id} lane-id {lane_id} hilink {type}" \| no-more` | 获取Serdes转储信息 |

#### 离线日志解析

交换机离线日志主要有两种形式：
1. **CLI命令输出日志**：包含各种交换机命令的执行结果
2. **诊断信息输出**：由交换机诊断工具生成的结构化日志

**日志文件位置**：
- CLI输出日志：通常为单个文件（如`switch_cli_output.txt`）或按命令分类的多个文件
- 诊断信息输出：通常为带有诊断标记的文件（如`diag_info.txt`）

**数据类型与来源**：

| 数据类型 | 日志来源特征 | 说明 |
|----------|--------------|------|
| 活动告警详情 | 包含`AlarmId, AlarmName, AlarmType, State : active`字段的内容块 | 从CLI输出日志中提取活动告警的详细信息 |
| 历史告警详情 | 包含`AlarmId, AlarmName, AlarmType, State : cleared`字段的内容块 | 从CLI输出日志中提取已清除告警的详细信息 |
| 活动告警 | 包含`Sequence, AlarmId, Severity, Date Time, Description`字段的表格 | 从CLI输出日志中提取活动告警摘要 |
| 历史告警 | 包含`Sequence, AlarmId, Severity, Date Time, Description`字段的表格且带有历史标记 | 从CLI输出日志中提取历史告警记录 |
| LLDP邻居 | 包含`Local Interface, Exptime(s), Neighbor Interface, Neighbor Device`字段的表格 | 从CLI输出日志中提取LLDP邻居信息 |
| 光模块信息 | 包含`Items, Value, HighAlarm, HighWarn, LowAlarm, Status`字段的表格 | 从CLI输出日志中提取光模块监控数据 |
| 接口摘要 | 包含`Interface, PHY, Protocol, InUti, OutUti, inErrors, outErrors`字段的表格 | 从CLI输出日志中提取接口基本状态 |
| 误码率 | 包含`Current state, Speed`字段的内容块 | 从CLI输出日志中提取接口误码率信息 |
| 接口信息 | 包含`current state, Description, Port Mode`字段的内容块 | 从CLI输出日志中提取接口详细配置 |
| 许可证ESN | 包含`MainBoard, ESN`字段的内容块 | 从CLI输出日志中提取交换机序列号 |
| 系统时钟 | 包含`clock, Time Zone`字段的内容块 | 从CLI输出日志中提取交换机当前时间 |
| 收发器信息 | 包含`transceiver information:`标记的内容块 | 从CLI输出日志中提取收发器详细信息 |
| HCCS相关信息 | 包含`HCCS`关键字的各种表格和内容块 | 从CLI输出日志中提取HCCS协议相关的各种统计信息 |

---


## 诊断逻辑

### 诊断逻辑概述

诊断工具基于多源数据采集和分析，实现对集群设备的故障诊断。本文档面向测试人员，详细描述各诊断片段的输入数据、诊断逻辑和可能的输出结果。所有诊断逻辑均与设计文档中的数据源紧密关联，支持在线SSH采集和离线日志解析两种模式。

### 主机相关诊断片段

#### 主机光模块综合诊断
**输入**：
- 主机SSH在线采集：
  - 光模块信息：`hccn_tool -i {chip_phy_id} -optical -g`
  - 链路状态：`hccn_tool -i {chip_phy_id} -link_stat -g`
- 主机离线日志（版本1）：
  - `hccn_tool.log` (Optical信息)
  - `npu_card_info.log` (NPU信息)
- 主机离线日志（版本2）：
  - `hccn_log/optical.log` (光模块信息)
  - `npu_smi_log/npu_smi.log` (NPU信息)
- 主机离线日志（版本3）：
  - `optical.log` (光模块信息)

**诊断逻辑**：检查光模块状态、功率、SNR、CDR参数、uncorr_cw_cnt和IIC故障等多个维度，结合预定义阈值判断异常。

**异常输出**：
- 光模块功率异常：当TX/RX功率值超出阈值范围时
  - 示例："光模块功率异常，TX功率：-5dBm（阈值范围：-3~0dBm）"
- SNR异常：当SNR值低于阈值(如12dB)时
  - 示例："光模块SNR异常，当前值：10.5dB（阈值：12dB）"
- CDR失锁：当CDR状态为"Unlock"时
  - 示例："光模块CDR失锁，状态：Unlock"
- uncorr_cw_cnt超阈值：当uncorr_cw_cnt值大于预定义阈值时
  - 示例："光模块uncorr_cw_cnt超阈值，当前值：1000（阈值：500）"
- IIC通信故障：当IIC通信状态为"Failed"时
  - 示例："光模块IIC通信故障，状态：Failed"

#### 主机环回诊断
**输入**：
- 主机SSH在线采集：`hccn_tool -i {npu_id} -optical -t {model}` (环回测试结果)
- 主机离线日志（版本1）：`hccn_tool.log` (Optical信息)
- 主机离线日志（版本2）：`hccn_log/optical.log` (光模块信息)
- 主机离线日志（版本3）：`optical.log` (光模块信息)

**诊断逻辑**：检查loopback测试的状态码，识别环回失败情况。

**异常输出**：
- 环回测试失败：当环回测试状态码为非0值时
  - 示例："环回测试失败，状态码：1，指示主机内部光链路或模块故障"

#### 主机光模块Los/LoL诊断
**输入**：
- 主机SSH在线采集：`hccn_tool -i {chip_phy_id} -optical -g` (tx_los、rx_los、rx_lol状态)
- 主机离线日志（版本1）：`hccn_tool.log` (Optical信息)
- 主机离线日志（版本2）：`hccn_log/optical.log` (光模块信息)
- 主机离线日志（版本3）：`optical.log` (光模块信息)

**诊断逻辑**：解析光模块状态字段，判断是否存在光信号丢失或激光关断。

**异常输出**：
- TX Los告警：当tx_los字段值为"1"时
  - 示例："光模块TX Los告警，tx_los状态：1"
- RX Los告警：当rx_los字段值为"1"时
  - 示例："光模块RX Los告警，rx_los状态：1"
- RX LoL告警：当rx_lol字段值为"1"时
  - 示例："光模块RX LoL告警，rx_lol状态：1"

#### 主机NPU端口状态诊断
**输入**：
- 主机SSH在线采集：
  - 链路状态：`hccn_tool -i {chip_phy_id} -link_status -g`
  - 网络健康状态：`hccn_tool -i {chip_phy_id} -net_health -g`
- 主机离线日志（版本1）：`hccn_tool.log` (link status信息)
- 主机离线日志（版本2）：`hccn_log/optical.log` (网络健康信息)

**诊断逻辑**：检查NPU端口的光模块存在状态、网络健康状态和连接状态。

**异常输出**：
- 端口故障：当端口状态字段值为"Fault"时
  - 示例："NPU端口故障，状态：Fault"
- 网络异常：当网络健康状态字段值为"Abnormal"时
  - 示例："NPU端口网络异常，健康状态：Abnormal"
- 连接断开：当连接状态字段值为"Disconnected"时
  - 示例："NPU端口连接断开，状态：Disconnected"

#### 主机间光链路诊断
**输入**：
- 主机SSH在线采集：`hccn_tool -i {chip_phy_id} -optical -g` (光模块参数)
- 主机离线日志（版本1）：`hccn_tool.log` (Optical信息)
- 主机离线日志（版本2）：`hccn_log/optical.log` (光模块信息)
- 主机离线日志（版本3）：`optical.log` (光模块信息)

**诊断逻辑**：对主机间连接的光模块功率、SNR和电流等参数进行多维度检查。

**异常输出**：
- 主机间光链路功率异常：当主机间连接的光模块TX/RX功率值超出阈值范围时
  - 示例："主机间光链路功率异常，TX功率：-6dBm（阈值范围：-3~0dBm）"
- SNR异常：当主机间连接的光模块SNR值低于阈值时
  - 示例："主机间光链路SNR异常，当前值：11.2dB（阈值：12dB）"
- 电流异常：当主机间连接的光模块电流值超出阈值范围时
  - 示例："主机间光链路电流异常，当前值：15.5mA（阈值范围：5~15mA）"

#### RoCE端口配置诊断
**输入**：
- 主机SSH在线采集：
  - 端口速度：`hccn_tool -i {chip_phy_id} -speed -g`
  - 双工模式：`hccn_tool -i {chip_phy_id} -duplex -g`
- 主机离线日志（版本1）：`hccn_tool.log` (speed信息)
- 主机离线日志（版本2）：`hccn_log/net_conf.log` (端口速度信息)
- 主机离线日志（版本3）：`optical.log` (speed info)

**诊断逻辑**：对比NPU端口与对端交换机端口的速率和双工模式配置。

**异常输出**：
- 速率不匹配：当NPU端口速率与对端交换机端口速率不一致时
  - 示例："RoCE端口速率不匹配，NPU端口：100Gbps，交换机端口：50Gbps"
- 双工模式不匹配：当NPU端口双工模式与对端交换机端口双工模式不一致时
  - 示例："RoCE端口双工模式不匹配，NPU端口：Full，交换机端口：Half"

### BMC相关诊断片段

#### BMC错误代码分析
**输入**：
- BMC SSH在线采集：`ipmcget -d sel -v list` (SEL日志)
- BMC离线日志：
  - `AppDump/event/sel.txt` (系统事件日志)
  - `AppDump/event/current_event.txt` (当前健康事件)

**诊断逻辑**：解析BMC日志中的事件代码，识别硬件异常。

**异常输出**：
- 多Bit ECC故障：当事件代码包含"0x28000010"时
  - 示例："BMC硬件异常，事件代码：0x28000010，多Bit ECC故障"
- AIV算子超时：当事件代码包含"0x28000011"时
  - 示例："BMC硬件异常，事件代码：0x28000011，AIV算子超时"
- 硬件组件故障：当事件代码包含硬件故障相关代码时
  - 示例："BMC硬件异常，事件代码：0x28000012，硬件组件故障"

#### BMC光模块诊断
**输入**：
- BMC SSH在线采集：
  - 传感器信息：`ipmcget -t sensor -d list`
  - 光模块历史日志（当前未实现）
- BMC离线日志：
  - `AppDump/network_adapter/optical_module/optical_module_history_info_log.csv` (光模块历史日志1)
  - `AppDump/CpuMem/NpuIO/optical_module_history_info_log.csv` (光模块历史日志2)

**诊断逻辑**：检查光功率、偏置电流、SNR等参数是否超出阈值，以及Los状态是否异常。

**异常输出**：
- 光功率异常：当光功率值超出阈值范围时
  - 示例："BMC光模块功率异常，RX功率：-25dBm（阈值范围：-20~-10dBm）"
- 偏置电流异常：当偏置电流值超出阈值范围时
  - 示例："BMC光模块偏置电流异常，当前值：16.2mA（阈值范围：5~15mA）"
- SNR异常：当SNR值低于阈值时
  - 示例："BMC光模块SNR异常，当前值：10.8dB（阈值：12dB）"
- 链路Los告警：当Los状态字段值为"1"时
  - 示例："BMC光模块链路Los告警，Los状态：1"

#### HCCS链路降级诊断
**输入**：
- BMC SSH在线采集：`ipmcget -d healthevents` (健康事件日志)
- BMC离线日志：`AppDump/event/current_event.txt` (当前健康事件)

**诊断逻辑**：解析特定错误代码(0x28000049)的事件描述，定位故障端口。

**异常输出**：
- HCCS链路降级：当事件代码包含"0x28000049"时
  - 示例："HCCS链路降级，事件代码：0x28000049，指示故障的L1交换机端口或CPU板抽屉"

### 交换机相关诊断片段

#### 交换机光模块诊断
**输入**：
- 交换机SSH在线采集：`dis optical-module interface {interface}` (光模块信息)
- 交换机离线日志：CLI命令输出中的光模块信息表格（包含`Items, Value, HighAlarm, HighWarn, LowAlarm, Status`字段）

**诊断逻辑**：分析交换机端口间的光模块功率、SNR和电流等参数，支持单端和双端诊断。

**异常输出**：
- 光模块功率异常：当TX/RX功率值超出阈值范围时
  - 示例："交换机光模块功率异常，TX功率：-4dBm（阈值范围：-3~0dBm）"
- SNR异常：当SNR值低于阈值时
  - 示例："交换机光模块SNR异常，当前值：11.5dB（阈值：12dB）"
- 电流异常：当电流值超出阈值范围时
  - 示例："交换机光模块电流异常，当前值：15.8mA（阈值范围：5~15mA）"

#### 交换机端口误码率诊断
**输入**：
- 交换机SSH在线采集：`display interface troubleshooting {interface}` (误码率信息)
- 交换机离线日志：CLI命令输出中的误码率信息（包含`Current state, Speed`字段的内容块）

**诊断逻辑**：检查端口的误码率是否超过阈值。

**异常输出**：
- 误码率超阈值：当误码率值大于预定义阈值(如1e-12)时
  - 示例："交换机端口误码率超阈值，当前值：5e-12（阈值：1e-12），指示链路质量问题"

#### 交换机CRC错误告警诊断
**输入**：
- 交换机SSH在线采集：`display alarm active` (活动告警)
- 交换机离线日志：活动告警信息表格（包含`Sequence, AlarmId, Severity, Date Time, Description`字段）

**诊断逻辑**：解析特定错误代码(0x081300bc)的告警信息，识别CRC错误快速增长的端口。

**异常输出**：
- 端口CRC错误快速增长：当告警信息包含错误代码"0x081300bc"时
  - 示例："交换机端口CRC错误快速增长，告警ID：0x081300bc，端口：GigabitEthernet0/0/1，指示链路质量或硬件故障"

#### 交换机端口降lane诊断
**输入**：
- 交换机SSH在线采集：`display alarm active` (活动告警)
- 交换机离线日志：活动告警信息表格（包含`Sequence, AlarmId, Severity, Date Time, Description`字段）

**诊断逻辑**：解析特定错误代码(0xf10509)的告警信息，识别发生降lane的端口。

**异常输出**：
- 端口降lane告警：当告警信息包含错误代码"0xf10509"时
  - 示例："交换机端口降lane告警，告警ID：0xf10509，端口：GigabitEthernet0/0/2，指示链路或硬件故障"

#### 交换机光模块Los告警诊断
**输入**：
- 交换机SSH在线采集：`display alarm active` (活动告警)
- 交换机离线日志：活动告警信息表格（包含`Sequence, AlarmId, Severity, Date Time, Description`字段）

**诊断逻辑**：解析特定错误代码(0x8130059)的告警信息，识别光模块链路Los告警的端口。

**异常输出**：
- 光模块链路Los告警：当告警信息包含错误代码"0x8130059"时
  - 示例："交换机光模块链路Los告警，告警ID：0x8130059，端口：GigabitEthernet0/0/3，指示光信号丢失"

#### 交换机光模块状态诊断
**输入**：
- 交换机SSH在线采集：`display interface transceiver verbose` (收发器详细信息)
- 交换机离线日志：CLI命令输出中的收发器信息（包含`transceiver information:`标记的内容块）

**诊断逻辑**：检查光模块State Flag、Datapath State和Module State等字段的状态值。

**异常输出**：
- 光模块状态异常：当State Flag、Datapath State或Module State字段值为异常状态时
  - 示例："交换机光模块状态异常，State Flag：0x00000001，Datapath State：Fault，指示收发光指标、通道状态或功率模式问题"

### 通用诊断片段

#### 端口lane功率差异诊断
**输入**：
- 主机SSH在线采集：`hccn_tool -i {chip_phy_id} -optical -g` (光模块lane功率信息)
- 交换机SSH在线采集：`dis optical-module interface {interface}` (光模块lane功率信息)
- BMC SSH在线采集：传感器信息（`ipmcget -t sensor -d list`）
- 离线日志：光模块lane功率数据（来自主机、交换机或BMC的日志文件）

**诊断逻辑**：计算同一端口不同lane间的功率最大值和最小值差值，判断是否超过阈值(3db)。

**异常输出**：
- lane间功率差异过大：当同一端口不同lane间的功率最大值和最小值差值超过阈值(3db)时
  - 示例："端口lane功率差异过大，端口：eth0，最大差值：4.2db（阈值：3db），指示端口内部lane故障"

### HCCS相关诊断片段

#### HCCS RP TX超时诊断
**输入**：
- 交换机SSH在线采集：
  - `display hccs proxy response statistics` (HCCS代理响应统计)
  - `display hccs proxy response detail interface {interface}` (HCCS代理响应详情)
- 交换机离线日志：CLI命令输出中的HCCS相关统计信息（包含HCCS关键字的表格）

**诊断逻辑**：分析RP TX超时的接口和地址映射关系，检查端口状态和对端接口状态。

**异常输出**：
- 端口长期down、闪断、窝包等导致的RP TX超时：当HCCS代理响应统计中RP TX超时次数大于0时
  - 示例："HCCS RP TX超时，接口：eth0，超时次数：10，可能原因：端口长期down、闪断或窝包"

#### HCCS RX超时诊断
**输入**：
- 交换机SSH在线采集：
  - `display hccs proxy response statistics` (HCCS代理响应统计)
  - `display interface` (接口状态)
  - `display for info enp s 1 c {chip_id} "get port link start 0 end 47"` (端口链路状态)
- 交换机离线日志：
  - CLI命令输出中的HCCS相关统计信息（包含HCCS关键字的表格）
  - CLI命令输出中的接口状态信息（包含`current state, Description, Port Mode`字段）

**诊断逻辑**：筛选发生RX超时的接口，结合链路状态、降lane情况等判断故障原因。

**异常输出**：
- 端口长期down、闪断、链路降lane或XPU设备异常导致的RX超时：当HCCS代理响应统计中RX超时次数大于0时
  - 示例："HCCS RX超时，接口：eth1，超时次数：5，可能原因：端口闪断或链路降lane"

#### HCCS Serdes诊断
**输入**：
- 交换机SSH在线采集：`display for info enp s 1 c {chip_id} "get port serdes dump-info marco-id {port_id} lane-id {lane_id} hilink {type}"` (Serdes转储信息)
- 交换机离线日志：CLI命令输出中的Serdes转储信息

**诊断逻辑**：检查CDR失锁状态和电源故障代码，识别Serdes异常。

**异常输出**：
- CDR失锁：当CDR状态为"Unlock"时
  - 示例："HCCS Serdes CDR失锁，端口：eth0，lane：1"
- 电源故障：当电源状态字段值为"Fault"时
  - 示例："HCCS Serdes电源故障，端口：eth0，lane：2"

#### HCCS端口SNR诊断
**输入**：
- 交换机SSH在线采集：`display interface hilink snr` (HCCS端口信噪比)
- 交换机离线日志：CLI命令输出中的HCCS端口SNR信息（包含`display interface hilink snr`输出的表格）

**诊断逻辑**：对比端口SNR值与阈值，识别SNR低于阈值的异常端口。

**异常输出**：
- SNR低于阈值：当SNR值低于阈值(如12dB)时
  - 示例："HCCS端口SNR异常，接口：eth2，当前SNR：10.5dB（阈值：12dB），指示链路质量问题"
