# äºšå¥åº·çƒ­åˆ‡æµç¨‹ï¼ˆPlantUML æ—¶åºå›¾ï¼‰

ä»¥ä¸‹ä¸ºPyTorchäºšå¥åº·çƒ­åˆ‡æ—¶åºå›¾ï¼Œä½¿ç”¨PlantUMLè¯­æ³•ç¼–å†™ï¼š

```plantuml
@startuml
participant device_plugin
participant clusterd
participant ascend_operator
participant volcano
participant taskd_manager
participant taskd_agent
participant mindio_controller
participant mindspeed_llm
participant mindio_processor
participant torch_npu
participant cann

== è®­ç»ƒæ‹‰èµ·ä¸æ•…éšœæ£€æµ‹ ==
activate device_plugin
device_plugin -> clusterd : èŠ¯ç‰‡æ•…éšœä¸ŠæŠ¥(deviceinfo cm)
activate clusterd

taskd_manager -> mindio_controller : æ‹‰èµ·
taskd_agent -> mindspeed_llm : æ‹‰èµ·è®­ç»ƒè¿›ç¨‹
activate mindspeed_llm
mindspeed_llm -> mindio_processor : æ‹‰èµ·ã€æ³¨å†Œå›è°ƒcallback
deactivate mindspeed_llm

clusterd -> clusterd : æ•…éšœæ±‡æ€»åˆ†æ
note right of clusterd
  å†…éƒ¨æ•…éšœèšåˆä¸å†³ç­–
end note

== åœæ­¢è®­ç»ƒ ==
deactivate mindio_processor
deactivate mindspeed_llm
deactivate mindio_controller

clusterd -> taskd_manager : hot switchä¿¡å·ï¼Œæš‚åœè®­ç»ƒ
activate taskd_manager
taskd_manager -> mindio_controller : tft_notify_controller_prepare_action
deactivate taskd_manager

== åˆ›å»ºå¤‡ä»½pod ==
clusterd -> ascend_operator : é€šè¿‡æ ‡ç­¾é€šçŸ¥ascend-operatoråˆ›å»ºå¤‡ä»½pod
activate ascend_operator
ascend_operator -> ascend_operator : åˆ›å»ºå¤‡ä»½pod
deactivate ascend_operator
volcano -> volcano : è°ƒåº¦å¤‡ä»½pod

== ç­–ç•¥ä¸ŠæŠ¥ ==
mindio_controller -> mindio_controller : controlleræ£€æµ‹åˆ°æ–°èŠ‚ç‚¹æ³¨å†Œä¸Šæ¥æµè½¬STATE_OP_STEP_FINISHçŠ¶æ€
activate mindio_controller
mindio_controller -> mindio_processor : é€šçŸ¥OP_PAUSE
mindio_controller -> taskd_manager : report_recover_strategy
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportRecoverStrategy
deactivate taskd_manager

== åˆ é™¤äºšå¥åº·pod ==
clusterd -> volcano : é€šè¿‡æ ‡ç­¾é€šçŸ¥volcanoåˆ é™¤äºšå¥åº·pod

== ç­–ç•¥ä¸‹å‘ ==
clusterd -> clusterd : ç­‰å¾…äºšå¥åº·podåˆ é™¤æˆåŠŸ
clusterd -> taskd_manager : changeStrategy:migration
activate taskd_manager
taskd_manager -> mindio_controller : tft_notify_controller_change_strategy:migration(controlleræµè½¬STATE_OP_MIGRATIONçŠ¶æ€ï¼‰
deactivate taskd_manager
activate mindio_controller

== æ¢å¤æµç¨‹ ==
mindio_controller -> mindio_processor : OP_PT_COMM
activate mindio_processor
mindio_processor -> mindspeed_llm : arf_rebuild_process_group_callback
deactivate mindio_processor

activate mindspeed_llm
mindspeed_llm -> torch_npu : reinit_process_group
deactivate mindspeed_llm
activate torch_npu
torch_npu -> cann : HcclCommDestroy
deactivate torch_npu

mindio_controller -> mindio_processor : é€šçŸ¥ OP_REPAIR
activate mindio_processor
mindio_processor -> mindspeed_llm : repair_callback
deactivate mindio_processor

mindio_controller -> mindio_processor : é€šçŸ¥ OP_ROLLBACK
activate mindio_processor
mindio_processor -> mindspeed_llm : rollback_callback
deactivate mindio_processor

mindio_controller -> mindio_processor : é€šçŸ¥ OP_NOTIFY_NORMAL
activate mindio_processor
mindio_processor -> mindspeed_llm : æ¢å¤è®­ç»ƒ
deactivate mindio_processor

mindio_controller -> taskd_manager : report_recover_status(controlleræµè½¬STATE_OP_NORMALçŠ¶æ€ï¼‰
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportRecoverStatus
deactivate taskd_manager

deactivate device_plugin
deactivate clusterd
@enduml
```

ä»¥ä¸‹ä¸ºMindSporeäºšå¥åº·çƒ­åˆ‡æ—¶åºå›¾ï¼Œä½¿ç”¨PlantUMLè¯­æ³•ç¼–å†™ï¼š

```plantuml
@startuml
participant device_plugin
participant clusterd
participant ascend_operator
participant volcano
participant taskd_manager
participant taskd_agent
participant mindio_controller
participant mindspore
participant mindio_processor
participant cann

== è®­ç»ƒæ‹‰èµ·ä¸æ•…éšœæ£€æµ‹ ==
activate device_plugin
device_plugin -> clusterd : èŠ¯ç‰‡æ•…éšœä¸ŠæŠ¥(deviceinfo cm)
activate clusterd

taskd_manager -> mindio_controller : æ‹‰èµ·
taskd_agent -> mindspore : æ‹‰èµ·è®­ç»ƒè¿›ç¨‹
activate mindspore
mindspore -> mindio_processor : æ‹‰èµ·ã€æ³¨å†Œå›è°ƒcallback
deactivate mindspore

clusterd -> clusterd : æ•…éšœæ±‡æ€»åˆ†æ
note right of clusterd
  å†…éƒ¨æ•…éšœèšåˆä¸å†³ç­–
end note

== åœæ­¢è®­ç»ƒ ==
deactivate mindio_processor
deactivate mindio_controller

clusterd -> taskd_manager : hot switchä¿¡å·ï¼Œæš‚åœè®­ç»ƒ
activate taskd_manager
taskd_manager -> mindio_controller : tft_notify_controller_prepare_action
deactivate taskd_manager

== åˆ›å»ºå¤‡ä»½pod ==
activate mindio_controller
mindio_controller -> mindio_controller : controlleræ£€æµ‹åˆ°æ–°èŠ‚ç‚¹æ³¨å†Œä¸Šæ¥æµè½¬STATE_OP_STEP_FINISHçŠ¶æ€
mindio_controller -> mindio_processor : é€šçŸ¥OP_PAUSE
deactivate mindio_controller
clusterd -> ascend_operator : é€šè¿‡æ ‡ç­¾é€šçŸ¥ascend-operatoråˆ›å»ºå¤‡ä»½pod
activate ascend_operator
ascend_operator -> ascend_operator : åˆ›å»ºå¤‡ä»½pod
deactivate ascend_operator
volcano -> volcano : è°ƒåº¦å¤‡ä»½pod

== ç­–ç•¥ä¸ŠæŠ¥ ==
mindio_controller -> taskd_manager : report_recover_strategy
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportRecoverStrategy
deactivate taskd_manager

== åˆ é™¤äºšå¥åº·pod ==
clusterd -> volcano : é€šè¿‡æ ‡ç­¾é€šçŸ¥volcanoåˆ é™¤äºšå¥åº·pod

== ç­–ç•¥ä¸‹å‘ ==
clusterd -> clusterd : ç­‰å¾…äºšå¥åº·podåˆ é™¤æˆåŠŸ
clusterd -> taskd_manager : changeStrategy:migration
activate taskd_manager
taskd_manager -> mindio_controller : tft_notify_controller_change_strategy:migration(controlleræµè½¬STATE_OP_MIGRATIONçŠ¶æ€ï¼‰
deactivate taskd_manager
activate mindio_controller

== æ¢å¤æµç¨‹ ==
mindio_controller -> mindio_processor : OP_PT_COMM
activate mindio_processor
mindio_processor -> mindspore : _tft_rebuild_groups
deactivate mindio_processor

activate mindspore
mindspore -> mindspore : _finalize_comm
mindspore -> cann : aclrtSetDevice
mindspore -> cann : HcclCommDestroy
mindspore -> cann : aclrtResetDevice
mindspore -> mindspore : _rebuild_group->CollectiveManager::CreateCommunicationGroup
mindspore -> cann : aclrtSetDevice
mindspore -> cann : HcclCommInitRootInfoConfig
mindspore -> cann : aclrtResetDevice
deactivate mindspore

mindio_controller -> mindio_processor : é€šçŸ¥ OP_REPAIR
activate mindio_processor
mindio_processor -> mindspore : _tft_repair_callback
deactivate mindio_processor

mindio_controller -> mindio_processor : é€šçŸ¥ OP_NOTIFY_NORMAL
activate mindio_processor
mindio_processor -> mindspore : æ¢å¤è®­ç»ƒ
deactivate mindio_processor

mindio_controller -> taskd_manager : report_recover_status(controlleræµè½¬STATE_OP_NORMALçŠ¶æ€ï¼‰
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportRecoverStatus
deactivate taskd_manager

deactivate device_plugin
deactivate clusterd

@enduml
```

> ğŸ’¡ **ä½¿ç”¨æç¤º**ï¼š
> - åœ¨ **VS Code** ä¸­å¯å®‰è£…æ’ä»¶ï¼š**Markdown Plantuml Preview**