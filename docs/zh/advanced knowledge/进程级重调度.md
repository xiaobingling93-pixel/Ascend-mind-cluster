# è¿›ç¨‹çº§é‡è°ƒåº¦æµç¨‹ï¼ˆPlantUML æ—¶åºå›¾ï¼‰

## ä»¥ä¸‹ä¸ºPytorchè¿›ç¨‹çº§é‡è°ƒåº¦æ—¶åºå›¾ï¼Œä½¿ç”¨PlantUMLè¯­æ³•ç¼–å†™ï¼š

```plantuml
@startuml
participant device_plugin
participant noded
participant clusterd
participant ascend_operator
participant volcano
participant taskd_manager
participant mindio_controller
participant taskd_agent
participant mindspeed_llm
participant mindio_processor
participant torch_npu
participant cann

== è®­ç»ƒæ‹‰èµ·ä¸æ•…éšœæ£€æµ‹ ==
activate device_plugin
activate noded
device_plugin -> clusterd : èŠ¯ç‰‡æ•…éšœä¸ŠæŠ¥(deviceinfo cm)
activate clusterd
noded -> clusterd : èŠ‚ç‚¹æ•…éšœä¸ŠæŠ¥(nodeinfo cm)

taskd_manager -> mindio_controller : æ‹‰èµ·
activate mindio_controller
taskd_agent -> mindspeed_llm : æ‹‰èµ·è®­ç»ƒè¿›ç¨‹
activate mindspeed_llm
mindspeed_llm -> mindio_processor : æ‹‰èµ·ã€æ³¨å†Œå›è°ƒcallback
deactivate mindspeed_llm
mindio_controller -> taskd_manager : è½¯ä»¶æ•…éšœä¸ŠæŠ¥report_process_fault
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : è½¯ä»¶æ•…éšœä¸ŠæŠ¥ReportProcessFault
deactivate taskd_manager

clusterd -> clusterd : æ•…éšœæ±‡æ€»åˆ†æ
note right of clusterd
  å†…éƒ¨æ•…éšœèšåˆä¸å†³ç­–
end note

== åœæ­¢è®­ç»ƒ ==
deactivate mindio_processor
deactivate mindspeed_llm
deactivate mindio_controller

clusterd -> taskd_manager : stop train
activate taskd_manager
taskd_manager -> mindio_controller : tft_notify_controller_stop_train(controlleræµè½¬STATE_OP_NORMALçŠ¶æ€ï¼‰
deactivate taskd_manager
activate mindio_controller
mindio_controller -> mindio_processor : OP_PRELOCK

== åœæ­¢å®ŒæˆåŠç­–ç•¥ä¸ŠæŠ¥ ==
mindio_controller -> taskd_manager : report_stop_complete
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportStopComplete
deactivate taskd_manager

clusterd -> taskd_manager : notify all fault ranks & exit fault nodes
activate taskd_manager
taskd_manager -> taskd_agent : exit fault nodes
activate taskd_agent
taskd_agent -> volcano : åˆ é™¤æ•…éšœpod ERRORï¼Œvolcanoåˆ é™¤ERROR pod
deactivate taskd_agent
activate volcano
volcano -> ascend_operator : operatoræ£€æµ‹åˆ°podä¸æ»¡è¶³æœ€å°å‰¯æœ¬è¦æ±‚åˆ›å»ºæ–°pod
deactivate volcano
taskd_manager -> mindio_controller : tft_notify_controller_on_global_rank
deactivate taskd_manager
activate mindio_controller

mindio_controller -> taskd_manager : report_recover_strategy
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportRecoverStrategy
deactivate taskd_manager

== ç­–ç•¥ä¸‹å‘ ==
clusterd -> taskd_manager : changeStrategy:recover
activate taskd_manager
taskd_manager -> mindio_controller : tft_notify_controller_change_strategy:recover(controlleræµè½¬STATE_OP_ENV_CLEARçŠ¶æ€ï¼‰
deactivate taskd_manager
activate mindio_controller

== æ¢å¤æµç¨‹ ==
mindio_controller -> mindio_processor : é€šçŸ¥ OP_DEVICE_STOP
activate mindio_processor
mindio_processor -> mindspeed_llm : stop_callback
deactivate mindio_processor

activate mindspeed_llm
mindspeed_llm -> torch_npu : stop_device
deactivate mindspeed_llm

activate torch_npu
torch_npu -> cann : AclRtDeviceTaskAbort
deactivate torch_npu

mindio_controller -> mindio_processor : é€šçŸ¥ OP_DEVICE_CLEAN
activate mindio_processor
mindio_processor -> mindspeed_llm : clean_callback
deactivate mindio_processor

activate mindspeed_llm
mindspeed_llm -> torch_npu : restart_device
deactivate mindspeed_llm

mindio_controller -> mindio_controller : controlleræµè½¬STATE_OP_REPAIRçŠ¶æ€ï¼Œç­‰å¾…æ–°èŠ‚ç‚¹è®­ç»ƒè¿›ç¨‹å…¨éƒ¨æ³¨å†ŒæˆåŠŸ

mindio_controller -> mindio_processor : OP_PT_COMM
activate mindio_processor
mindio_processor -> mindspeed_llm : arf_rebuild_process_group_callback
deactivate mindio_processor

activate mindspeed_llm
mindspeed_llm -> torch_npu : reinit_process_group
deactivate mindspeed_llm
activate torch_npu
torch_npu -> cann : HcclCommDestroy
deactivate torch_npu

mindio_controller -> mindio_processor : é€šçŸ¥ OP_REPAIR
activate mindio_processor
mindio_processor -> mindspeed_llm : repair_callback
deactivate mindio_processor

mindio_controller -> mindio_processor : é€šçŸ¥ OP_ROLLBACK
activate mindio_processor
mindio_processor -> mindspeed_llm : rollback_callback
deactivate mindio_processor

mindio_controller -> mindio_processor : é€šçŸ¥ OP_NOTIFY_NORMAL
activate mindio_processor
mindio_processor -> mindspeed_llm : æ¢å¤è®­ç»ƒ
deactivate mindio_processor

mindio_controller -> taskd_manager : report_recover_status(controlleræµè½¬STATE_OP_NORMALçŠ¶æ€ï¼‰
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportRecoverStatus
deactivate taskd_manager

deactivate device_plugin
deactivate noded
deactivate clusterd
@enduml
```


## ä»¥ä¸‹ä¸ºMindSporeè¿›ç¨‹çº§é‡è°ƒåº¦æ—¶åºå›¾ï¼Œä½¿ç”¨PlantUMLè¯­æ³•ç¼–å†™ï¼š

```plantuml
@startuml
participant device_plugin
participant noded
participant clusterd
participant ascend_operator
participant volcano
participant taskd_manager
participant mindio_controller
participant taskd_agent
participant mindspore
participant mindio_processor
participant cann

== è®­ç»ƒæ‹‰èµ·ä¸æ•…éšœæ£€æµ‹ ==
activate device_plugin
activate noded
device_plugin -> clusterd : èŠ¯ç‰‡æ•…éšœä¸ŠæŠ¥(deviceinfo cm)
activate clusterd
noded -> clusterd : èŠ‚ç‚¹æ•…éšœä¸ŠæŠ¥(nodeinfo cm)

taskd_manager -> mindio_controller : æ‹‰èµ·
activate mindio_controller
taskd_agent -> mindspore : æ‹‰èµ·è®­ç»ƒè¿›ç¨‹
activate mindspore
mindspore -> mindio_processor : æ‹‰èµ·ã€æ³¨å†Œå›è°ƒcallback
deactivate mindspore
mindio_controller -> taskd_manager : è½¯ä»¶æ•…éšœä¸ŠæŠ¥report_process_fault
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : è½¯ä»¶æ•…éšœä¸ŠæŠ¥ReportProcessFault
deactivate taskd_manager

clusterd -> clusterd : æ•…éšœæ±‡æ€»åˆ†æ
note right of clusterd
  å†…éƒ¨æ•…éšœèšåˆä¸å†³ç­–
end note

== åœæ­¢è®­ç»ƒ ==
deactivate mindio_processor
deactivate mindspore
deactivate mindio_controller

clusterd -> taskd_manager : stop train
activate taskd_manager
taskd_manager -> mindio_controller : tft_notify_controller_stop_train(controlleræµè½¬STATE_OP_NORMALçŠ¶æ€ï¼‰
deactivate taskd_manager
activate mindio_controller
mindio_controller -> mindio_processor : OP_PRELOCK

== åœæ­¢å®ŒæˆåŠç­–ç•¥ä¸ŠæŠ¥ ==
mindio_controller -> taskd_manager : report_stop_complete
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportStopComplete
deactivate taskd_manager

clusterd -> taskd_manager : notify all fault ranks & exit fault nodes
activate taskd_manager
taskd_manager -> taskd_agent : exit fault nodes
activate taskd_agent
taskd_agent -> volcano : åˆ é™¤æ•…éšœpod ERRORï¼Œvolcanoåˆ é™¤ERROR pod
deactivate taskd_agent
activate volcano
volcano -> ascend_operator : operatoræ£€æµ‹åˆ°podä¸æ»¡è¶³æœ€å°å‰¯æœ¬è¦æ±‚åˆ›å»ºæ–°pod
deactivate volcano
taskd_manager -> mindio_controller : tft_notify_controller_on_global_rank
deactivate taskd_manager
activate mindio_controller

mindio_controller -> taskd_manager : report_recover_strategy
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportRecoverStrategy
deactivate taskd_manager

== ç­–ç•¥ä¸‹å‘ ==
clusterd -> taskd_manager : changeStrategy:recover
activate taskd_manager
taskd_manager -> mindio_controller : tft_notify_controller_change_strategy:recover(controlleræµè½¬STATE_OP_ENV_CLEARçŠ¶æ€ï¼‰
deactivate taskd_manager
activate mindio_controller

== æ¢å¤æµç¨‹ ==
mindio_controller -> mindio_processor : é€šçŸ¥ OP_DEVICE_STOP
activate mindio_processor
mindio_processor -> mindspore : _tft_stop_callback
deactivate mindio_processor

activate mindspore
mindspore -> mindspore : stop_device
mindspore -> cann : AclRtDeviceTaskAbort
deactivate mindspore

mindio_controller -> mindio_processor : é€šçŸ¥ OP_DEVICE_CLEAN
activate mindio_processor
mindio_processor -> mindspore : _tft_clean_callback
deactivate mindio_processor

activate mindspore
mindspore -> mindspore : _reset_snapshot_state
deactivate mindspore

mindio_controller -> mindio_controller : controlleræµè½¬STATE_OP_REPAIRçŠ¶æ€ï¼Œç­‰å¾…æ–°èŠ‚ç‚¹è®­ç»ƒè¿›ç¨‹å…¨éƒ¨æ³¨å†ŒæˆåŠŸ

mindio_controller -> mindio_processor : OP_PT_COMM
activate mindio_processor
mindio_processor -> mindspore : _tft_rebuild_groups
deactivate mindio_processor

activate mindspore
mindspore -> mindspore : _finalize_comm
mindspore -> cann : aclrtSetDevice
mindspore -> cann : HcclCommDestroy
mindspore -> cann : aclrtResetDevice
mindspore -> mindspore : _rebuild_group->CollectiveManager::CreateCommunicationGroup
mindspore -> cann : aclrtSetDevice
mindspore -> cann : HcclCommInitRootInfoConfig
mindspore -> cann : aclrtResetDevice
deactivate mindspore

mindio_controller -> mindio_processor : é€šçŸ¥ OP_REPAIR
activate mindio_processor
mindio_processor -> mindspore : _tft_repair_callback
deactivate mindio_processor

mindio_controller -> mindio_processor : é€šçŸ¥ OP_NOTIFY_NORMAL
activate mindio_processor
mindio_processor -> mindspore : æ¢å¤è®­ç»ƒ
deactivate mindio_processor

mindio_controller -> taskd_manager : report_recover_status(controlleræµè½¬STATE_OP_NORMALçŠ¶æ€ï¼‰
deactivate mindio_controller
activate taskd_manager
taskd_manager -> clusterd : ReportRecoverStatus
deactivate taskd_manager

deactivate device_plugin
deactivate noded
deactivate clusterd
@enduml
```

> ğŸ’¡ **ä½¿ç”¨æç¤º**ï¼š
> - åœ¨ **VS Code** ä¸­å¯å®‰è£…æ’ä»¶ï¼š**Markdown Plantuml Preview**